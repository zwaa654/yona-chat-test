<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yona Chat Test</title>
  <style>
    :root{
      --charcoal:#111827; --forest:#184A2C; --oak:#5C3A21;
      --bg:#0b0f14; --card:#ffffff; --line:#e8eaee; --text:#111827; --muted:#6b7280;
      --bubble:#111827; --bubbleText:#fff; --shadow:0 12px 30px rgba(0,0,0,.18);
      --green:#22c55e; --alert:#ef4444;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#e5e7eb; background:#0e141b; }

    .bg{ position:fixed; inset:0; z-index:-2; background:center/cover no-repeat; filter:brightness(.42) blur(2px); }
    @media (min-width:641px){ .bg{ background-image:url('bg-desktop.jpg'); } }
    @media (max-width:640px){ .bg{ background-image:url('bg-mobile.jpg'); } }

    .pagebar{
      position:sticky; top:0; width:100%; display:flex; align-items:center; gap:10px;
      background:rgba(17,24,39,.65); backdrop-filter: blur(8px);
      padding:10px 16px; border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:20px}
    .brand .fallback{font-weight:800; letter-spacing:.5px}
    .spacer{flex:1}
    .pill{color:#cbd5e1; font-size:12px; padding:6px 10px; border:1px solid rgba(255,255,255,.1); border-radius:999px}

    .yona-launcher{
      position:fixed; right:18px; bottom:18px; z-index:9998;
      display:flex; align-items:center; gap:10px; background:var(--bubble); color:#fff;
      border:1px solid var(--bubble); box-shadow:var(--shadow); padding:10px 14px; border-radius:24px; cursor:pointer; user-select:none;
    }
    .yona-launcher .dot{width:10px; height:10px; border-radius:50%; background:var(--green)}
    .yona-launcher .label{font-weight:700}
    .yona-launcher .badge{width:10px; height:10px; border-radius:50%; background:var(--alert); box-shadow:0 0 0 2px var(--bubble); display:none}
    .yona-launcher.unseen .badge{display:block}

    .yona-chat{
      position:fixed; z-index:9999; right:18px; bottom:18px;
      width:clamp(360px, 28vw, 520px); height:50vh;
      background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      display:none; overflow:hidden; color:var(--text);
    }
    .yona-chat.open{ display:flex; flex-direction:column; }

    .yona-chat header{
      padding:12px 14px; display:flex; align-items:center; gap:10px;
      border-bottom:1px solid var(--line); background:#fff;
    }
    .yona-chat header .dot{ width:10px; height:10px; border-radius:50%; background:var(--green) }
    .yona-chat header h2{ margin:0; font-size:15px }
    .yona-chat header .close{ margin-left:auto; border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer }

    .yona-chat main{ flex:1; overflow:auto; padding:14px; background:#f6f7f9 }
    .msg{ display:flex; margin:8px 0; gap:10px }
    .msg.me{ justify-content:flex-end }
    .bubble{ max-width:75%; padding:10px 12px; border-radius:14px; line-height:1.35; background:#fff; border:1px solid var(--line); white-space:pre-wrap }
    .msg.me .bubble{ background:var(--bubble); color:var(--bubbleText); border-color:var(--bubble) }

    .typing{ display:inline-block; width:36px }
    .typing span{ display:inline-block; width:6px; height:6px; margin:0 2px; background:#cbd5e1; border-radius:50%; animation:b 1.2s infinite ease-in-out }
    .typing span:nth-child(2){ animation-delay:0.15s } .typing span:nth-child(3){ animation-delay:0.3s }
    @keyframes b{ 0%,80%,100%{ transform:scale(.6); opacity:.6 } 40%{ transform:scale(1); opacity:1 } }

    .yona-chat footer{ background:#fff; border-top:1px solid var(--line); padding:10px }
    .bar{ display:flex; gap:8px }
    textarea{ flex:1; resize:none; padding:10px 12px; border-radius:12px; border:1px solid var(--line); font:inherit; min-height:44px; max-height:160px; outline:none }
    button{ padding:10px 14px; border-radius:12px; border:1px solid var(--charcoal); background:var(--charcoal); color:#fff; font-weight:600; cursor:pointer }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .hint{ font-size:12px; color:#6b7280; padding:6px 2px 0 }

    @media (max-width:640px){
      .yona-launcher{ left:50%; right:auto; transform:translateX(-50%); bottom:14px }
      .yona-chat{ right:0; left:0; bottom:0; top:0; width:100vw; height:100dvh; border-radius:0 }
    }
  </style>
</head>
<body>
  <div class="bg"></div>

  <div class="pagebar">
    <div class="brand">
      <img id="logo" src="logo.png" alt="Yona" onerror="this.style.display='none';document.getElementById('brand-fallback').style.display='block'">
      <div class="fallback" id="brand-fallback" style="display:none">YONA</div>
    </div>
    <div class="spacer"></div>
    <div class="pill">Proof of concept</div>
  </div>

  <div class="yona-launcher" id="yona-launcher" aria-label="Open chat" role="button">
    <div class="dot" aria-hidden="true"></div>
    <div class="label">Chat</div>
    <div class="badge" aria-hidden="true"></div>
  </div>

  <div class="yona-chat" id="yona-chat" aria-live="polite" aria-label="Yona chat">
    <header>
      <div class="dot" aria-hidden="true"></div>
      <h2>Yona Support</h2>
      <button class="close" id="yona-close" type="button">Close</button>
    </header>

    <main id="log"></main>

    <footer>
      <form class="bar" id="form">
        <textarea id="input" placeholder="Type a message. Press Enter to send (Shift+Enter for new line)"></textarea>
        <button id="send" type="submit">Send</button>
      </form>
      <div class="hint">AI replies via Apps Script. History loads on open; refresh to see Sheet-sent replies.</div>
    </footer>
  </div>

  <script>
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbzIPcXu5kBNFElrRmm-tSHd0Y9Yy8Mny5cCJjnhT7cghY_hVP7o3ipfgYRTTDLtc_PAtw/exec";

    const launcher = document.getElementById('yona-launcher');
    const panel    = document.getElementById('yona-chat');
    const closeBtn = document.getElementById('yona-close');
    const logEl    = document.getElementById('log');
    const form     = document.getElementById('form');
    const input    = document.getElementById('input');

    // State for de-duplication
    let lastId = 0;              // highest row id we've rendered
    let openedOnce = false;

    function addMsg(role, text){
      const row = document.createElement('div');
      row.className = 'msg ' + (role === 'me' ? 'me' : 'bot');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.innerText = text;
      row.appendChild(b);
      logEl.appendChild(row);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function addTyping(){
      const row = document.createElement('div');
      row.className = 'msg bot'; row.id = 'typing';
      const b = document.createElement('div'); b.className='bubble';
      b.innerHTML = '<span class="typing"><span></span><span></span><span></span></span>';
      row.appendChild(b); logEl.appendChild(row); logEl.scrollTop = logEl.scrollHeight;
    }
    function removeTyping(){ const t=document.getElementById('typing'); if(t) t.remove(); }

    // Fetch and render only messages with id > lastId
    async function fetchNew() {
      const res = await fetch(ENDPOINT_URL, { method:'POST', body: JSON.stringify({ poll:true, since:lastId }) });
      const data = await res.json();
      const msgs = Array.isArray(data?.messages) ? data.messages : [];
      for (const m of msgs) {
        if ((m.id || 0) > lastId) {
          addMsg(m.who === 'user' ? 'me' : 'bot', m.text || '');
          lastId = m.id;
        }
      }
      return msgs.length;
    }

    // Open chat: load history once (no intervals)
    function openChat(){
      panel.classList.add('open');
      if (!openedOnce) {
        openedOnce = true;
        fetchNew().catch(()=>{});
      }
      setTimeout(()=> input.focus(), 50);
    }
    function closeChat(){ panel.classList.remove('open'); }

    launcher.addEventListener('click', openChat);
    closeBtn.addEventListener('click', closeChat);

    // Send -> show user msg immediately, call backend, then pull ONLY new rows and render them
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = input.value.trim(); if(!text) return;
      input.value=''; input.style.height='44px';

      // optimistic user bubble (so it's instant)
      addMsg('me', text);
      addTyping();

      let userRowId = lastId; // remember where we were
      try {
        const res = await fetch(ENDPOINT_URL, { method:'POST', body: JSON.stringify({ message:text }) });
        const data = await res.json().catch(()=> ({}));

        // If backend returns the user's row id, advance lastId to at least that,
        // so our next fetch only brings the bot row (avoids duplicating the user bubble).
        if (typeof data.id === 'number') {
          if (data.id > lastId) lastId = data.id;
        }

        removeTyping();

        // Now fetch whatever is new (likely just the bot reply row)
        await fetchNew();

      } catch (_) {
        removeTyping();
        addMsg('bot','Oops â€” could not reach server.');
      }
    });
  </script>
</body>
</html>
