<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yona Chat Test</title>
  <style>
    :root{
      --charcoal:#111827; --bg:#0e141b; --card:#ffffff; --line:#e8eaee; --text:#111827;
      --bubble:#111827; --bubbleText:#fff; --shadow:0 12px 30px rgba(0,0,0,.18);
      --green:#22c55e; --alert:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:#e5e7eb;
    }

    /* Real Yona screenshots as background */
    .bg{ position:fixed; inset:0; z-index:-2; background:#0e141b center/cover no-repeat; filter:brightness(.45) blur(1.5px); }
    .bg.mobile{ display:none }
    @media (max-width:640px){
      .bg.desktop{ display:none }
      .bg.mobile{ display:block }
    }

    /* Faux site header to make it feel real */
    .pagebar{
      position:sticky; top:0; display:flex; align-items:center; gap:10px;
      background:rgba(17,24,39,.65); backdrop-filter:blur(8px);
      padding:10px 16px; border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{ display:flex; align-items:center; gap:10px }
    .brand img{ height:22px }
    .brand .fallback{ font-weight:800; letter-spacing:.5px }
    .spacer{ flex:1 }
    .pill{ color:#cbd5e1; font-size:12px; padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px }

    /* Launcher button */
    .yona-launcher{
      position:fixed; right:18px; bottom:18px; z-index:9998;
      display:flex; align-items:center; gap:10px;
      background:var(--bubble); color:#fff; border:1px solid var(--bubble);
      box-shadow:var(--shadow); padding:10px 14px; border-radius:24px;
      cursor:pointer; user-select:none;
    }
    .yona-launcher .dot{ width:10px; height:10px; border-radius:50%; background:var(--green) }
    .yona-launcher .label{ font-weight:700 }
    .yona-launcher .badge{ width:10px; height:10px; border-radius:50%; background:var(--alert); box-shadow:0 0 0 2px var(--bubble); display:none }
    .yona-launcher.unseen .badge{ display:block }

    /* Chat panel */
    .yona-chat{
      position:fixed; z-index:9999; right:18px; bottom:18px;
      width:clamp(360px, 28vw, 520px); height:50vh;
      background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      display:none; overflow:hidden; color:var(--text);
    }
    .yona-chat.open{ display:flex; flex-direction:column }
    .yona-chat header{
      padding:12px 14px; display:flex; align-items:center; gap:10px;
      border-bottom:1px solid var(--line); background:#fff;
    }
    .yona-chat header .dot{ width:10px; height:10px; border-radius:50%; background:var(--green) }
    .yona-chat header h2{ margin:0; font-size:15px }
    .yona-chat header .ai{ margin-left:6px; font-size:11px; color:#065f46; background:#d1fae5; border:1px solid #a7f3d0; padding:2px 6px; border-radius:999px }
    .yona-chat header .close{ margin-left:auto; border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer }

    .yona-chat main{ flex:1; overflow:auto; padding:14px; background:#f6f7f9 }
    .msg{ display:flex; margin:8px 0; gap:10px }
    .msg.me{ justify-content:flex-end }
    .bubble{ max-width:75%; padding:10px 12px; border-radius:14px; line-height:1.35; background:#fff; border:1px solid var(--line); white-space:pre-wrap }
    .msg.me .bubble{ background:var(--bubble); color:var(--bubbleText); border-color:var(--bubble) }

    .typing{ display:inline-block; width:36px }
    .typing span{ display:inline-block; width:6px; height:6px; margin:0 2px; background:#cbd5e1; border-radius:50%; animation:b 1.2s infinite ease-in-out }
    .typing span:nth-child(2){ animation-delay:0.15s } .typing span:nth-child(3){ animation-delay:0.3s }
    @keyframes b{0%,80%,100%{ transform:scale(.6); opacity:.6 } 40%{ transform:scale(1); opacity:1 }}

    .yona-chat footer{ background:#fff; border-top:1px solid var(--line); padding:10px }
    .bar{ display:flex; gap:8px }
    textarea{ flex:1; resize:none; padding:10px 12px; border-radius:12px; border:1px solid var(--line); font:inherit; min-height:44px; max-height:160px; outline:none }
    button{ padding:10px 14px; border-radius:12px; border:1px solid var(--charcoal); background:var(--charcoal); color:#fff; font-weight:600; cursor:pointer }
    button:disabled{ opacity:.6; cursor:not-allowed }

    /* Mobile: launcher centered & panel full-screen */
    @media (max-width:640px){
      .yona-launcher{ left:50%; right:auto; transform:translateX(-50%); bottom:14px }
      .yona-chat{ right:0; left:0; bottom:0; top:0; width:100vw; height:100dvh; border-radius:0 }
    }
  </style>
</head>
<body>
  <!-- Backgrounds -->
  <div class="bg desktop" style="background-image:url('bg-desktop.jpg')"></div>
  <div class="bg mobile"  style="background-image:url('bg-mobile.jpg')"></div>

  <!-- Faux site header -->
  <div class="pagebar">
    <div class="brand">
      <img id="logo" src="logo.png" alt="Yona" onerror="this.style.display='none';document.getElementById('brand-fallback').style.display='block'">
      <div class="fallback" id="brand-fallback" style="display:none">YONA</div>
    </div>
    <div class="spacer"></div>
    <div class="pill" id="ai-pill">AI: unknown</div>
  </div>

  <!-- Launcher -->
  <div class="yona-launcher" id="yona-launcher" aria-label="Open chat" role="button">
    <div class="dot" aria-hidden="true"></div>
    <div class="label">Chat</div>
    <div class="badge" aria-hidden="true"></div>
  </div>

  <!-- Chat panel -->
  <div class="yona-chat" id="yona-chat" aria-live="polite" aria-label="Yona chat">
    <header>
      <div class="dot" aria-hidden="true"></div>
      <h2>Yona Support</h2>
      <span class="ai" id="ai-chip">…</span>
      <button class="close" id="yona-close" type="button">Close</button>
    </header>

    <main id="log"></main>

    <footer>
      <form class="bar" id="form">
        <textarea id="input" placeholder="Type a message. Enter to send (Shift+Enter = new line)"></textarea>
        <button id="send" type="submit">Send</button>
      </form>
    </footer>
  </div>

  <script>
    // ---- CONFIG ----
    const GAS_URL      = "https://script.google.com/macros/s/AKfycbzIPcXu5kBNFElrRmm-tSHd0Y9Yy8Mny5cCJjnhT7cghY_hVP7o3ipfgYRTTDLtc_PAtw/exec"; // your Apps Script /exec URL
    const OLLAMA_URL   = "https://41e24dc39b25.ngrok-free.app"; // <-- paste your current ngrok https URL

  const OLLAMA_MODEL = "llama3.1:8b";
  // -----------------

  const launcher = document.getElementById('yona-launcher');
  const panel    = document.getElementById('yona-chat');
  const closeBtn = document.getElementById('yona-close');
  const logEl    = document.getElementById('log');
  const form     = document.getElementById('form');
  const input    = document.getElementById('input');
  const aiChip   = document.getElementById('ai-chip');
  const aiPill   = document.getElementById('ai-pill');

  function addMsg(role, text){
    const row = document.createElement('div');
    row.className = 'msg ' + (role === 'me' ? 'me' : 'bot');
    const b = document.createElement('div');
    b.className = 'bubble'; b.innerText = text;
    row.appendChild(b); logEl.appendChild(row); logEl.scrollTop = logEl.scrollHeight;
  }
  function addTyping(){
    const row = document.createElement('div'); row.className='msg bot'; row.id='typing';
    const b = document.createElement('div'); b.className='bubble';
    b.innerHTML = '<span class="typing"><span></span><span></span><span></span></span>';
    row.appendChild(b); logEl.appendChild(row); logEl.scrollTop = logEl.scrollHeight;
  }
  function removeTyping(){ const t=document.getElementById('typing'); if(t) t.remove(); }

  input.addEventListener('input', ()=>{ input.style.height='auto'; input.style.height=Math.min(input.scrollHeight,160)+'px'; });
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); } });

  let lastId = 0, pollFast=null, pollSlow=null, inFlight=false, unseen=0, aiOn=null;
  const seen = new Set(); // <-- de-dupe ids we’ve rendered

  function setAIIndicators(on){
    aiOn = !!on;
    aiChip.textContent = aiOn ? 'AI is ON' : 'AI is OFF';
    aiChip.style.color = aiOn ? '#065f46' : '#991b1b';
    aiChip.style.background = aiOn ? '#d1fae5' : '#fee2e2';
    aiChip.style.border = '1px solid ' + (aiOn ? '#a7f3d0' : '#fecaca');
    aiPill.textContent = 'AI: ' + (aiOn ? 'ON' : 'OFF');
  }

  async function poll(){
    if (inFlight) return;
    try{
      inFlight = true;
      const res = await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ poll:true, since:lastId }) });
      const data = await res.json();
      if (typeof data?.ai_on === 'boolean') setAIIndicators(data.ai_on);
      const msgs = Array.isArray(data?.messages) ? data.messages : [];
      let newOnes = 0;
      for (const m of msgs){
        if (seen.has(m.id)) { lastId = Math.max(lastId, m.id); continue; }
        lastId = Math.max(lastId, m.id);
        seen.add(m.id);
        addMsg(m.who === 'user' ? 'me' : 'bot', m.text || '');
        if (!panel.classList.contains('open')) newOnes++;
      }
      if (newOnes > 0){ launcher.classList.add('unseen'); unseen += newOnes; }
    } catch { /* ignore */ }
    finally { inFlight = false; }
  }

  function startFast(){ if(pollFast) return; pollFast = setInterval(()=>{ if(panel.classList.contains('open') && !document.hidden) poll(); }, 2000); }
  function stopFast(){ if(!pollFast) return; clearInterval(pollFast); pollFast=null; }
  function startSlow(){ if(pollSlow) return; pollSlow = setInterval(()=>{ if(!panel.classList.contains('open')) poll(); }, 10000); }
  function stopSlow(){ if(!pollSlow) return; clearInterval(pollSlow); pollSlow=null; }

  function openChat(){ panel.classList.add('open'); if(unseen>0){ unseen=0; launcher.classList.remove('unseen'); } poll(); startFast(); input.focus(); }
  function closeChat(){ panel.classList.remove('open'); stopFast(); }
  launcher.addEventListener('click', openChat);
  closeBtn.addEventListener('click', closeChat);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden && panel.classList.contains('open')){ poll(); startFast(); } });

  async function callOllama(messages){
    const res = await fetch(`${OLLAMA_URL}/api/chat`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ model: OLLAMA_MODEL, messages, stream:false })
    });
    const json = await res.json();
    const text = json?.message?.content || json?.choices?.[0]?.message?.content || '';
    return text.trim();
  }

  function buildLocalContext(){
    const nodes = Array.from(logEl.querySelectorAll('.msg')).slice(-12);
    const ctx = [];
    for (const n of nodes){
      const role = n.classList.contains('me') ? 'user' : 'assistant';
      const text = n.querySelector('.bubble')?.innerText || '';
      ctx.push({ role, content: text });
    }
    return ctx;
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = input.value.trim(); if(!text) return;
    input.value=''; input.style.height='44px';
    addMsg('me', text); addTyping();

    try{
      // 1) Log user on server and get its row id
      const a = await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ message:text }) }).then(r=>r.json());
      if (typeof a?.ai_on === 'boolean') setAIIndicators(a.ai_on);
      if (a?.id){ seen.add(a.id); lastId = Math.max(lastId, a.id); } // prevent echo of our own user message

      // 2) If AI OFF → stop here (you’ll reply from Outbox)
      if (!aiOn){ removeTyping(); return; }

      // 3) AI ON → call local model via ngrok
      const context = buildLocalContext();
      const reply = await callOllama([
        { role:'system', content:'You are a friendly, concise Yona support agent (eco-friendly, minimal, strong furniture). If unsure, ask a brief clarifying question.' },
        ...context,
        { role:'user', content: text }
      ]) || "…";

      // 4) Show + log bot; capture bot row id to avoid duplicate on next poll
      removeTyping(); addMsg('bot', reply);
      const b = await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ role:'bot', message: reply }) }).then(r=>r.json()).catch(()=> ({}));
      if (b?.id){ seen.add(b.id); lastId = Math.max(lastId, b.id); }

    } catch (err){
      removeTyping();
      addMsg('bot', "Couldn't reach the AI tunnel. Is ngrok running and OLLAMA_URL set?");
    }
  });

  // Boot: gentle background polling so Outbox replies pop in even when closed
  startSlow();
</script>

</body>
</html>
